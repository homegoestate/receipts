<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>專業地政士費用結算系統 (Nexus Ultimate V2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@600;900&display=swap');
        
        :root {
            --paper-width: 210mm;
            --paper-height: 296mm;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #e5e7eb; 
            -webkit-user-select: none; user-select: none;
            overflow: hidden; 
        }
        .serif { font-family: 'Noto Serif TC', serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .input-custom {
            width: 100%; border: 1px solid #d1d5db; border-radius: 4px;
            padding: 6px 8px; font-size: 14px; outline: none; transition: 0.2s;
        }
        .input-custom:focus { border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }

        /* --- 智慧選單層級 --- */
        .autocomplete-suggestions {
            position: absolute; 
            border: 1px solid #cbd5e1; 
            z-index: 9999; 
            top: 100%; left: 0; right: 0; 
            background-color: #ffffff;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-height: 250px; 
            overflow-y: auto; 
            display: none;
            border-radius: 0 0 6px 6px;
        }
        .autocomplete-suggestions div { 
            padding: 10px 12px; 
            cursor: pointer; 
            font-size: 14px; 
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
        }
        .autocomplete-suggestions div:hover { background-color: #eff6ff; color: #1d4ed8; }
        
        .row-wrapper { position: relative; z-index: 10; }
        .row-wrapper.active-row { z-index: 50; }

        /* A4 紙張設定 */
        #previewContainer {
            background-color: #52525b; 
            display: flex; justify-content: center; align-items: flex-start;
            padding: 20px; overflow-y: auto; height: 100vh;
        }
        #paper {
            width: var(--paper-width); height: var(--paper-height);
            background: white; box-shadow: 0 0 20px rgba(0,0,0,0.3);
            position: relative; padding: 10mm 12mm; box-sizing: border-box;
            display: flex; flex-direction: column; transform-origin: top center; overflow: hidden;
        }
        #scalableContent {
            display: flex; flex-direction: column; flex-grow: 1; height: 100%; transform-origin: top center;
        }

        /* 雙欄佈局 */
        .columns-container { display: flex; gap: 15px; flex-grow: 1; align-items: flex-start; }
        .column-box { flex: 1; border: 1px solid #e5e7eb; border-radius: 4px; display: flex; flex-direction: column; }
        .column-header { padding: 6px 10px; border-bottom: 2px solid; font-weight: bold; font-size: 11pt; background-color: #f9fafb; }

        .bill-table { width: 100%; border-collapse: collapse; font-size: 10pt; }
        .bill-table td { padding: 4px 6px; border-bottom: 1px solid #f3f4f6; }
        .amount-col { text-align: right; font-family: 'Roboto', sans-serif; font-weight: 500; white-space: nowrap; }
        
        .footer-section { margin-top: auto; padding-top: 10px; border-top: 2px solid #374151; }
        .stamp-box {
            border: 3px double #ef4444; color: #ef4444; padding: 4px 8px;
            display: inline-block; transform: rotate(-2deg);
            font-family: 'Noto Serif TC', serif; background: rgba(255,255,255,0.95);
            min-width: 110px; text-align: center;
        }

        /* --- 關鍵修復：印章隱藏邏輯 --- */
        /* 當父容器 #paper 擁有 .hide-stamp 類別時，隱藏印章 */
        #paper.hide-stamp .stamp-visual {
            visibility: hidden !important;
            opacity: 0 !important;
        }

        @media print {
            @page { size: A4; margin: 0; }
            body * { visibility: hidden; }
            #previewContainer, #previewContainer * { visibility: visible; }
            #previewContainer {
                position: absolute; left: 0; top: 0; padding: 0; margin: 0;
                width: 210mm; height: 296mm; background: white; overflow: hidden; display: block;
            }
            #paper { box-shadow: none; margin: 0; transform: none !important; width: 100%; height: 100%; }
            .no-print { display: none !important; }
            
            /* 列印時強制套用隱藏邏輯 */
            #paper.hide-stamp .stamp-visual { display: none !important; }
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen" onclick="closeAllLists(event)">

    <div class="w-full md:w-[400px] bg-white border-r border-gray-300 flex flex-col z-20 shadow-2xl no-print h-full">
        <div class="p-4 bg-slate-800 text-white shrink-0">
            <h2 class="font-bold text-xl mb-4 text-center tracking-wider"><i class="fas fa-file-invoice-dollar mr-2"></i>專業結算系統 V2</h2>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <button onclick="document.getElementById('caseInput').click()" class="bg-orange-600 hover:bg-orange-500 text-white py-2.5 rounded shadow font-bold transition flex items-center justify-center gap-2">
                    <i class="fas fa-folder-open"></i> 讀取舊檔
                </button>
                <input type="file" id="caseInput" class="hidden" accept=".json" onchange="loadCase(this)">
                <button onclick="saveCase()" class="bg-blue-600 hover:bg-blue-500 text-white py-2.5 rounded shadow font-bold transition flex items-center justify-center gap-2">
                    <i class="fas fa-save"></i> 儲存收據
                </button>
            </div>
            <button onclick="resetCase()" class="w-full bg-slate-700 hover:bg-red-600 text-gray-300 hover:text-white py-1.5 rounded text-xs transition border border-slate-600">
                <i class="fas fa-redo mr-1"></i> 開啟新案件 (清空)
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 hide-scrollbar">
            <div class="bg-white p-3 rounded shadow-sm border border-gray-200">
                <div class="flex gap-2 mb-2">
                    <label class="flex-1 cursor-pointer border rounded p-1.5 flex justify-center hover:bg-blue-50 peer-checked:bg-blue-100 transition">
                        <input type="radio" name="firm" value="yicheng" checked onchange="updateView()" class="mr-2"> 易丞
                    </label>
                    <label class="flex-1 cursor-pointer border rounded p-1.5 flex justify-center hover:bg-green-50 transition">
                        <input type="radio" name="firm" value="hongguo" onchange="updateView()" class="mr-2"> 宏國
                    </label>
                </div>
                <div class="flex gap-2 text-sm bg-yellow-50 p-2 rounded border border-yellow-100">
                    <label class="flex-1 flex items-center justify-center cursor-pointer"><input type="radio" name="clientType" value="individual" checked onchange="calculateTotal()" class="mr-1"> 個人</label>
                    <label class="flex-1 flex items-center justify-center cursor-pointer"><input type="radio" name="clientType" value="company" onchange="calculateTotal()" class="mr-1"> 公司</label>
                </div>
            </div>

            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <input type="date" id="inputDate" class="input-custom" title="日期">
                    <input type="text" id="inputClientId" class="input-custom" placeholder="統編 (選填)">
                </div>
                <input type="text" id="inputClient" class="input-custom" placeholder="客戶抬頭">
                <textarea id="inputTarget" rows="2" class="input-custom" placeholder="案件標的 / 地址"></textarea>
            </div>

            <div class="border-t pt-2">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-700">A. 代辦費</h3>
                    <div class="flex gap-1">
                        <button onclick="openOptionManager('service')" class="px-2 py-1 bg-gray-200 rounded text-xs"><i class="fas fa-cog"></i></button>
                        <button onclick="addItem('service')" class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-bold">+ 新增</button>
                    </div>
                </div>
                <div id="serviceItems" class="space-y-1"></div>
                <div class="mt-2 flex items-center gap-2 bg-green-50 p-2 rounded border border-green-200">
                    <span class="text-green-700 text-xs font-bold">折扣</span>
                    <input type="text" id="discountName" value="老客戶優惠" class="flex-1 text-xs border rounded p-1">
                    <input type="text" id="discountAmount" value="0" onchange="applyMath(this)" class="w-16 text-right text-xs border rounded p-1">
                </div>
            </div>

            <div class="border-t pt-2">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-700">B. 代納規費</h3>
                    <div class="flex gap-1">
                        <button onclick="openOptionManager('tax')" class="px-2 py-1 bg-gray-200 rounded text-xs"><i class="fas fa-cog"></i></button>
                        <button onclick="addItem('tax')" class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs font-bold">+ 新增</button>
                    </div>
                </div>
                <div id="taxItems" class="space-y-1"></div>
            </div>

            <div class="border-t pt-2 bg-yellow-50 p-2 rounded">
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold w-16">找補</span>
                        <input type="text" id="adjustName" value="稅費找補" class="flex-1 text-xs border rounded p-1">
                        <input type="text" id="adjustAmount" value="0" onchange="applyMath(this)" class="w-16 text-right text-xs border rounded p-1">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold w-16 text-red-600">預收</span>
                        <input type="text" value="預收規費" class="flex-1 text-xs border rounded p-1 bg-gray-100" disabled>
                        <input type="text" id="prepayAmount" value="0" onchange="applyMath(this)" class="w-16 text-right text-xs border rounded p-1 text-red-600 font-bold">
                    </div>
                </div>
            </div>

            <div class="border-t pt-2 pb-10">
                <label class="text-xs font-bold text-gray-500">備註事項</label>
                <textarea id="inputNotes" rows="4" class="input-custom text-xs">◎若要辦理地價稅自用，請於9月22日前申請。
◎若要辦理房屋稅自用，請於3月22日前申請。
◎辦理自用稅率需先將戶籍遷入。
◎上列地政士代辦費，本事務所列為執行業務收入，若付款人為中華民國境內之公司行號或機關團體，請依法扣繳10%稅款 ，並開立扣繳憑單予本事務所。</textarea>
            </div>
        </div>

        <div class="p-4 bg-white border-t shrink-0">
             <div class="flex justify-center gap-4 mb-2 text-xs">
                <label class="flex items-center cursor-pointer select-none">
                    <input type="radio" name="printMode" value="pdf" checked onchange="toggleStampMode()" class="mr-1"> 
                    存檔PDF (有章)
                </label>
                <label class="flex items-center cursor-pointer select-none">
                    <input type="radio" name="printMode" value="print" onchange="toggleStampMode()" class="mr-1"> 
                    直接列印 (無章)
                </label>
            </div>
            <button onclick="window.print()" class="w-full bg-slate-800 hover:bg-slate-700 text-white py-3 rounded-lg shadow font-bold text-lg transition">
                <i class="fas fa-print mr-2"></i>輸出 / 列印
            </button>
        </div>
    </div>

    <div id="previewContainer" class="flex-1">
        <div id="paper">
            <div id="scalableContent">
                <div id="headerBorder" class="flex justify-between items-end border-b-4 pb-2 mb-3">
                    <div>
                        <h1 id="firmName" class="text-4xl font-black serif tracking-widest leading-none">易丞地政士事務所</h1>
                        <div class="text-[11px] tracking-[0.4em] text-gray-500 mt-1 font-bold">PROFESSIONAL LAND AGENT</div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-gray-800 leading-none">各項規費及勞務費明細表</div>
                        <div class="text-xs text-gray-600 font-medium mt-1 bg-gray-100 px-2 py-0.5 rounded inline-block">
                            日期：<span id="displayDate"></span>
                        </div>
                    </div>
                </div>

                <div class="border border-gray-300 mb-3 text-sm">
                    <div class="flex border-b border-gray-300">
                        <div class="w-24 bg-gray-100 p-1.5 font-bold flex items-center justify-center border-r border-gray-300 text-gray-700">委託客戶</div>
                        <div class="flex-1 p-1.5 font-bold relative text-lg flex items-center">
                            <span id="displayClient"></span>
                            <span id="displayClientId" class="text-[10px] text-gray-500 ml-2 font-normal"></span>
                        </div>
                        <div class="w-24 bg-gray-100 p-1.5 font-bold flex items-center justify-center border-l border-r border-gray-300 text-gray-700">客戶類型</div>
                        <div class="w-24 p-1.5 flex items-center justify-center" id="displayClientType">個人</div>
                    </div>
                    <div class="flex">
                        <div class="w-24 bg-gray-100 p-1.5 font-bold flex items-center justify-center border-r border-gray-300 text-gray-700">案件標的</div>
                        <div class="flex-1 p-1.5 leading-relaxed whitespace-pre-wrap" id="displayTarget"></div>
                    </div>
                </div>

                <div class="columns-container">
                    <div class="column-box" id="colBoxService">
                        <div class="column-header" id="headerService">A. 地政士代辦費 (含稅)</div>
                        <div class="flex-1 p-1">
                            <table class="bill-table">
                                <tbody id="displayServiceRows"></tbody>
                                <tbody id="displayDiscountRow" class="text-green-700 hidden">
                                    <tr>
                                        <td class="pl-2 font-bold"><i class="fas fa-minus-circle text-[10px] mr-1"></i><span id="dName">折扣</span></td>
                                        <td class="amount-col font-bold">- <span id="dAmount">0</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="bg-gray-50 border-t border-gray-300 p-2 flex justify-between font-bold text-sm">
                            <span>代辦費小計</span>
                            <span id="totalService">$0</span>
                        </div>
                    </div>

                    <div class="column-box" id="colBoxTax">
                        <div class="column-header" id="headerTax">B. 代納規費 (實支實付)</div>
                        <div class="flex-1 p-1">
                            <table class="bill-table">
                                <tbody id="displayTaxRows"></tbody>
                            </table>
                        </div>
                        <div class="bg-gray-50 border-t border-gray-300 p-2 flex justify-between font-bold text-sm">
                            <span>代納規費小計</span>
                            <span id="totalTax">$0</span>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-6 mt-2 text-sm px-2">
                    <div id="rowAdjust" class="hidden font-bold">
                        <span id="txtAdjustName" class="mr-2">稅費找補:</span>
                        <span id="txtAdjustAmount">$0</span>
                    </div>
                    <div id="rowPrepay" class="hidden text-red-600 font-bold">
                        <span class="mr-2">減：預收規費:</span>
                        <span id="txtPrepayAmount">-$0</span>
                    </div>
                </div>

                <div class="footer-section">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 pr-4 flex gap-4">
                            <div class="flex-1 text-[10px] text-gray-600 leading-tight">
                                <div class="font-bold mb-1">備註 / 注意事項：</div>
                                <div id="displayNotes" class="whitespace-pre-wrap border border-gray-200 p-1.5 rounded bg-gray-50"></div>
                                <div class="mt-1 text-gray-400"><i class="fas fa-map-marker-alt mr-1"></i><span id="firmAddress"></span></div>
                            </div>
                            
                            <div class="stamp-visual flex flex-col items-center justify-center shrink-0">
                                <div class="stamp-box">
                                    <div class="stamp-inner">
                                        <h4 class="font-black text-base mb-1" id="stampFirmName">易丞地政士</h4>
                                        <div class="text-[9px] font-bold border-t border-b border-red-400 py-0.5 my-0.5">勞務費收據/印花總繳</div>
                                        <div class="text-[9px] font-bold leading-tight">
                                            統編：<span id="stampId"></span><br>
                                            負責人：<span id="stampAgent"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="w-[220px] text-right">
                             <div id="normalTotalBox">
                                <div class="text-gray-500 text-xs font-bold">總計實收金額 (Total)</div>
                                <div class="font-black text-4xl text-gray-800 serif leading-snug" id="grandTotal">$0</div>
                            </div>

                             <div id="companyTaxBox" class="hidden w-full text-sm">
                                <div class="flex justify-between text-gray-500"><span>應收總計:</span><span id="rawTotalAmount" class="font-bold">$0</span></div>
                                <div class="flex justify-between text-red-600 border-b border-gray-300 pb-1 mb-1"><span>減:10%稅款:</span><span id="taxDeductionAmount" class="font-bold">-$0</span></div>
                                <div class="flex justify-between items-end">
                                    <span class="font-bold text-gray-800">實收:</span>
                                    <span class="font-black text-3xl text-red-600 serif leading-none" id="netTotalAmount">$0</span>
                                </div>
                                <div class="text-[9px] text-gray-400 mt-1">* 代辦費>2萬，已扣10%稅款</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modalManager" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg w-[400px] shadow-2xl flex flex-col max-h-[80vh]">
            <div class="p-4 border-b bg-gray-100 flex justify-between items-center rounded-t-lg">
                <h3 class="font-bold text-gray-700" id="modalTitle">管理選單</h3>
                <button onclick="closeOptionManager()" class="text-gray-500 hover:text-black"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 flex-1 overflow-y-auto bg-gray-50">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="newOptionInput" class="flex-1 border rounded px-2 py-1 text-sm" placeholder="新選項名稱...">
                    <button onclick="addNewOptionToManager()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold">新增</button>
                </div>
                <div id="optionListContainer" class="space-y-1"></div>
            </div>
            <div class="p-3 border-t bg-gray-100 text-right rounded-b-lg">
                <button onclick="closeOptionManager()" class="bg-gray-800 text-white px-4 py-1.5 rounded text-sm font-bold">完成</button>
            </div>
        </div>
    </div>

<script>
    // --- 智能運算核心 ---
    // 允許輸入 1000+500, 500*2 等運算式，自動計算結果
    function safeCalculate(expression) {
        if (!expression) return 0;
        // 如果只是純數字，直接回傳
        if (!isNaN(expression)) return parseFloat(expression);
        
        try {
            // 安全過濾：只允許數字和運算符號
            const sanitized = expression.toString().replace(/[^0-9+\-*/().]/g, '');
            if (!sanitized) return 0;
            // 使用 Function 建構式進行計算 (比 eval 安全一點，但仍需小心，這裡已過濾)
            const result = new Function('return ' + sanitized)();
            
            // 如果結果不是數字 (例如除以0變無限大)，回傳0
            if (!isFinite(result) || isNaN(result)) return 0;
            return Math.round(result); // 取整數
        } catch (e) {
            console.warn("計算錯誤", e);
            return 0; // 計算失敗回傳 0
        }
    }

    // 綁定到 input 的輔助函式
    window.applyMath = function(el) {
        const val = el.value;
        const res = safeCalculate(val);
        el.value = res; // 更新欄位顯示運算後結果
        calculateTotal(); // 觸發總計
    }

    // ----------------------

    const firms = {
        yicheng: {
            name: "易丞地政士事務所", id: "92367068", agent: "楊翊晟", address: "台南市北區文賢路1080巷11號",
            color: "#1e40af", bg: "#eff6ff", border: "border-blue-800"
        },
        hongguo: {
            name: "宏國地政士事務所", id: "97956971", agent: "楊明宗", address: "台南市北區文賢路1080巷11號",
            color: "#166534", bg: "#f0fdf4", border: "border-green-800"
        }
    };
    
    const defaultServiceOpts = ["不動產移轉登記費", "抵押權設定代辦費", "水電過戶代辦費", "簽約費", "實價登錄費", "代辦住址隱匿及地籍異動即時通", "使用分區", "天然瓦斯過戶代辦費"];
    const defaultTaxOpts = ["土地及建物登記規費", "書狀費", "設定規費", "土地契約印花稅", "建物契約印花稅", "電費", "水費", "天然瓦斯費", "影印費", "謄本費", "分區使用證明申請費"];

    let currentServiceOpts = [], currentTaxOpts = [];
    let serviceItems = [{name: "不動產移轉登記費", price: 0}], taxItems = [{name: "土地及建物登記規費", price: 0}];
    let currentEditType = 'service';

    function init() {
        const today = new Date();
        document.getElementById('inputDate').value = today.toISOString().split('T')[0];
        updateDateDisplay(document.getElementById('inputDate').value);
        
        loadOptionsLocally();
        setupLiveUpdates();
        updateView();
        toggleStampMode();
        setTimeout(autoFitContent, 500); 
    }

    function autoFitContent() {
        const paper = document.getElementById('paper');
        const content = document.getElementById('scalableContent');
        const maxHeight = paper.clientHeight - 40; 
        
        content.style.transform = `scale(1)`;
        
        const contentHeight = content.scrollHeight;
        if (contentHeight > maxHeight) {
            const scale = maxHeight / contentHeight;
            const finalScale = Math.max(scale, 0.65); 
            content.style.transform = `scale(${finalScale})`;
        }
    }

    const observeDOM = (function(){
        const MutationObserver = window.MutationObserver || window.WebKitMutationObserver;
        return function( obj, callback ){
            if( !obj || !obj.nodeType === 1 ) return; 
            if( MutationObserver ){
                const obs = new MutationObserver(function(mutations, observer){ callback(mutations); });
                obs.observe( obj, { childList:true, subtree:true, attributes: true } );
            }
            else if( window.addEventListener ){
                obj.addEventListener('DOMNodeInserted', callback, false);
                obj.addEventListener('DOMNodeRemoved', callback, false);
            }
        }
    })();

    observeDOM( document.getElementById('scalableContent'), function(){ 
        clearTimeout(window.resizeTimer);
        window.resizeTimer = setTimeout(autoFitContent, 100);
    });

    function updateView() {
        const firmKey = document.querySelector('input[name="firm"]:checked').value;
        const data = firms[firmKey];
        
        document.getElementById('firmName').innerText = data.name;
        document.getElementById('firmName').style.color = data.color;
        document.getElementById('headerBorder').className = `flex justify-between items-end border-b-4 pb-2 mb-3 ${data.border}`;
        document.getElementById('firmAddress').innerText = data.address;
        
        document.getElementById('stampFirmName').innerText = data.name;
        document.getElementById('stampId').innerText = data.id;
        document.getElementById('stampAgent').innerText = data.agent;
        
        document.getElementById('headerService').style.color = data.color;
        document.getElementById('headerService').style.borderColor = data.color;
        document.getElementById('headerTax').style.color = data.color;
        document.getElementById('headerTax').style.borderColor = data.color;

        calculateTotal();
    }

    function calculateTotal() {
        // 先確保數據正確
        syncInputs();

        const sTotal = serviceItems.reduce((acc, i) => acc + (Number(i.price)||0), 0);
        const tTotal = taxItems.reduce((acc, i) => acc + (Number(i.price)||0), 0);
        
        const dAmount = Number(document.getElementById('discountAmount').value) || 0;
        const finalServiceTotal = sTotal - dAmount;

        const adjustAmount = Number(document.getElementById('adjustAmount').value) || 0;
        const prepayAmount = Number(document.getElementById('prepayAmount').value) || 0;

        const rawGrandTotal = finalServiceTotal + tTotal + adjustAmount - prepayAmount;
        const isCompany = document.querySelector('input[name="clientType"]:checked').value === 'company';
        
        document.getElementById('totalService').innerText = formatCurrency(finalServiceTotal);
        document.getElementById('totalTax').innerText = formatCurrency(tTotal);

        const dRow = document.getElementById('displayDiscountRow');
        if(dAmount > 0) {
            dRow.classList.remove('hidden');
            document.getElementById('dName').innerText = document.getElementById('discountName').value;
            document.getElementById('dAmount').innerText = formatCurrency(dAmount);
        } else {
            dRow.classList.add('hidden');
        }

        const rAdj = document.getElementById('rowAdjust');
        const tAdj = document.getElementById('txtAdjustAmount');
        if(adjustAmount !== 0) {
            rAdj.classList.remove('hidden');
            rAdj.className = adjustAmount < 0 ? "text-red-600 font-bold" : "text-blue-700 font-bold";
            document.getElementById('txtAdjustName').innerText = document.getElementById('adjustName').value + ":";
            tAdj.innerText = (adjustAmount>0?'+':'') + formatCurrency(adjustAmount);
        } else {
            rAdj.classList.add('hidden');
        }

        const rPre = document.getElementById('rowPrepay');
        if(prepayAmount > 0) {
            rPre.classList.remove('hidden');
            document.getElementById('txtPrepayAmount').innerText = '-' + formatCurrency(prepayAmount);
        } else {
            rPre.classList.add('hidden');
        }

        const normalBox = document.getElementById('normalTotalBox');
        const companyBox = document.getElementById('companyTaxBox');

        if(isCompany && finalServiceTotal > 20000) {
            normalBox.classList.add('hidden');
            companyBox.classList.remove('hidden');
            const tax = Math.round(finalServiceTotal * 0.1);
            document.getElementById('rawTotalAmount').innerText = formatCurrency(rawGrandTotal);
            document.getElementById('taxDeductionAmount').innerText = '-' + formatCurrency(tax);
            document.getElementById('netTotalAmount').innerText = formatCurrency(rawGrandTotal - tax);
            document.getElementById('displayClientType').innerText = "公司行號";
        } else {
            normalBox.classList.remove('hidden');
            companyBox.classList.add('hidden');
            document.getElementById('grandTotal').innerText = formatCurrency(rawGrandTotal);
            document.getElementById('displayClientType').innerText = isCompany ? "公司行號" : "個人";
        }

        renderRows('displayServiceRows', serviceItems);
        renderRows('displayTaxRows', taxItems);
        autoFitContent();
    }

    function renderRows(id, items) {
        const tbody = document.getElementById(id);
        tbody.innerHTML = '';
        items.forEach(item => {
            if(!item.name && !item.price) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${item.name}</td><td class="amount-col">${item.price ? formatCurrency(item.price) : '-'}</td>`;
            tbody.appendChild(tr);
        });
    }

    function setupLiveUpdates() {
        document.getElementById('inputDate').addEventListener('input', (e) => updateDateDisplay(e.target.value));
        ['inputClient','inputClientId','inputTarget','inputNotes'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                document.getElementById(id.replace('input','display')).innerText = e.target.value;
                autoFitContent(); 
            });
             document.getElementById(id.replace('input','display')).innerText = document.getElementById(id).value;
        });
    }

    function syncInputs() {
        serviceItems.forEach((item, i) => {
            const n = document.getElementById(`in-service-name-${i}`);
            const p = document.getElementById(`in-service-price-${i}`);
            if(n) item.name = n.value;
            if(p) item.price = Number(p.value);
        });
        taxItems.forEach((item, i) => {
            const n = document.getElementById(`in-tax-name-${i}`);
            const p = document.getElementById(`in-tax-price-${i}`);
            if(n) item.name = n.value;
            if(p) item.price = Number(p.value);
        });
    }

    // --- 新增：排序功能 ---
    window.moveItem = function(type, index, direction) {
        syncInputs(); // 先保存當前輸入
        const arr = type === 'service' ? serviceItems : taxItems;
        const newIndex = index + direction;
        
        // 邊界檢查
        if (newIndex < 0 || newIndex >= arr.length) return;
        
        // 交換位置
        [arr[index], arr[newIndex]] = [arr[newIndex], arr[index]];
        
        renderEditor(type);
        calculateTotal();
    }
    // -------------------

    function renderEditor(type) {
        const arr = type === 'service' ? serviceItems : taxItems;
        const container = document.getElementById(type+'Items');
        container.innerHTML = '';
        arr.forEach((item, i) => {
            const div = document.createElement('div');
            // row-wrapper active-row 是修復 z-index 關鍵
            div.className = "flex gap-1 items-center mb-1 row-wrapper";
            div.innerHTML = `
                <div class="flex flex-col gap-0.5 mr-1">
                    <button onclick="moveItem('${type}', ${i}, -1)" class="text-[10px] bg-gray-200 hover:bg-gray-300 px-1 rounded h-4 flex items-center justify-center text-gray-600" title="上移"><i class="fas fa-chevron-up"></i></button>
                    <button onclick="moveItem('${type}', ${i}, 1)" class="text-[10px] bg-gray-200 hover:bg-gray-300 px-1 rounded h-4 flex items-center justify-center text-gray-600" title="下移"><i class="fas fa-chevron-down"></i></button>
                </div>
                <div class="relative flex-1">
                    <input type="text" id="in-${type}-name-${i}" value="${item.name}" 
                        class="w-full border rounded px-2 py-1 text-sm focus:bg-blue-50 outline-none transition" placeholder="項目名稱"
                        oninput="handleEditorInput('${type}', ${i}, 'name', this)"
                        onfocus="showSuggest('${type}', ${i}, this)" 
                        onblur="setTimeout(() => hideSuggest('${type}', ${i}), 200)"
                        autocomplete="off">
                    <div id="sug-${type}-${i}" class="autocomplete-suggestions"></div>
                </div>
                <input type="text" id="in-${type}-price-${i}" value="${item.price}" 
                    class="w-20 border rounded px-2 py-1 text-sm text-right outline-none focus:bg-blue-50 transition" placeholder="$"
                    onchange="applyMath(this); handleEditorInput('${type}', ${i}, 'price', this)">
                <button onclick="delItem('${type}', ${i})" class="text-gray-400 hover:text-red-500 w-6"><i class="fas fa-times"></i></button>
            `;
            container.appendChild(div);
        });
    }

    window.addItem = function(type) {
        syncInputs();
        (type==='service'?serviceItems:taxItems).push({name:"", price:""});
        renderEditor(type);
    }
    window.delItem = function(type, i) {
        syncInputs();
        (type==='service'?serviceItems:taxItems).splice(i, 1);
        renderEditor(type);
        calculateTotal();
    }
    window.handleEditorInput = function(type, i, field, el) {
        const arr = type === 'service' ? serviceItems : taxItems;
        arr[i][field] = field === 'price' ? Number(el.value) : el.value;
        if(field === 'name') showSuggest(type, i, el); 
        calculateTotal();
    }

    window.showSuggest = function(type, i, input) {
        const list = document.getElementById(`sug-${type}-${i}`);
        const opts = type === 'service' ? currentServiceOpts : currentTaxOpts;
        const val = input.value.toLowerCase();
        list.innerHTML = '';
        let count = 0;
        opts.forEach(opt => {
            if(opt.toLowerCase().includes(val)) {
                const d = document.createElement('div');
                d.innerHTML = opt.replace(new RegExp(`(${val})`,'gi'), '<b class="text-blue-600">$1</b>');
                d.onmousedown = (e) => {
                    e.preventDefault(); // 防止失去焦點
                    input.value = opt;
                    handleEditorInput(type, i, 'name', input);
                    list.style.display = 'none';
                    input.closest('.row-wrapper').classList.remove('active-row');
                };
                list.appendChild(d);
                count++;
            }
        });
        
        if (count > 0 && document.activeElement === input) {
            list.style.display = 'block';
            document.querySelectorAll('.active-row').forEach(el=>el.classList.remove('active-row'));
            input.closest('.row-wrapper').classList.add('active-row');
        } else {
            list.style.display = 'none';
            input.closest('.row-wrapper').classList.remove('active-row');
        }
    }
    
    window.hideSuggest = function(type, i) {
        const list = document.getElementById(`sug-${type}-${i}`);
        if(list) list.style.display = 'none';
        const row = list.closest('.row-wrapper');
        if(row) row.classList.remove('active-row');
    }

    function closeAllLists(e) {
        if(!e.target.closest('.row-wrapper')) {
            document.querySelectorAll('.autocomplete-suggestions').forEach(el => el.style.display='none');
            document.querySelectorAll('.active-row').forEach(el => el.classList.remove('active-row'));
        }
    }

    function loadOptionsLocally() {
        const s = localStorage.getItem('serviceOpts_v4');
        const t = localStorage.getItem('taxOpts_v4');
        currentServiceOpts = s ? JSON.parse(s) : [...defaultServiceOpts];
        currentTaxOpts = t ? JSON.parse(t) : [...defaultTaxOpts];
        refreshEditors();
    }
    function saveOptionsLocally() {
        localStorage.setItem('serviceOpts_v4', JSON.stringify(currentServiceOpts));
        localStorage.setItem('taxOpts_v4', JSON.stringify(currentTaxOpts));
    }
    function refreshEditors() { renderEditor('service'); renderEditor('tax'); }

    window.saveCase = function() {
        syncInputs();
        const data = {
            firm: document.querySelector('input[name="firm"]:checked').value,
            clientType: document.querySelector('input[name="clientType"]:checked').value,
            date: document.getElementById('inputDate').value,
            clientId: document.getElementById('inputClientId').value,
            client: document.getElementById('inputClient').value,
            target: document.getElementById('inputTarget').value,
            notes: document.getElementById('inputNotes').value,
            serviceItems, taxItems,
            discountName: document.getElementById('discountName').value,
            discountAmount: document.getElementById('discountAmount').value,
            adjustName: document.getElementById('adjustName').value,
            adjustAmount: document.getElementById('adjustAmount').value,
            prepayAmount: document.getElementById('prepayAmount').value
        };
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type: "application/json"}));
        a.download = `收據_${data.client}_${data.date.replace(/-/g,'')}.json`;
        a.click();
    }

    window.loadCase = function(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                if(d.serviceOpts && !d.firm) { 
                    if(confirm("這是設定檔，要匯入選項嗎？")) {
                        currentServiceOpts = d.serviceOpts; currentTaxOpts = d.taxOpts;
                        saveOptionsLocally();
                    }
                    return;
                }
                if(d.firm) document.querySelector(`input[name="firm"][value="${d.firm}"]`).checked = true;
                if(d.clientType) document.querySelector(`input[name="clientType"][value="${d.clientType}"]`).checked = true;
                document.getElementById('inputDate').value = d.date || '';
                updateDateDisplay(d.date);
                ['inputClient','inputClientId','inputTarget','inputNotes'].forEach(id => {
                    document.getElementById(id).value = d[id.replace('input','').charAt(0).toLowerCase() + id.replace('input','').slice(1)] || (id==='inputNotes'?d.notes:'');
                });
                document.getElementById('discountName').value = d.discountName||"折扣";
                document.getElementById('discountAmount').value = d.discountAmount||0;
                document.getElementById('adjustName').value = d.adjustName||"稅費找補";
                document.getElementById('adjustAmount').value = d.adjustAmount||0;
                document.getElementById('prepayAmount').value = d.prepayAmount||0;

                serviceItems = d.serviceItems || [];
                taxItems = d.taxItems || [];

                let learned = false;
                serviceItems.forEach(i => { if(i.name && !currentServiceOpts.includes(i.name)) { currentServiceOpts.push(i.name); learned=true; }});
                taxItems.forEach(i => { if(i.name && !currentTaxOpts.includes(i.name)) { currentTaxOpts.push(i.name); learned=true; }});
                if(learned) saveOptionsLocally();

                refreshEditors();
                updateView();
                alert("讀取成功！");
            } catch(err) { alert("檔案錯誤"); }
        };
        reader.readAsText(file);
        input.value = '';
    }

    window.resetCase = function() {
        if(!confirm("確定要開啟新案件嗎？")) return;
        document.getElementById('inputClient').value = "";
        document.getElementById('inputTarget').value = "";
        serviceItems = [{name:"", price:0}];
        taxItems = [{name:"", price:0}];
        document.getElementById('discountAmount').value = 0;
        document.getElementById('adjustAmount').value = 0;
        document.getElementById('prepayAmount').value = 0;
        refreshEditors();
        updateView();
        document.getElementById('inputNotes').value = "◎若要辦理地價稅自用，請於9月22日前申請。\n◎若要辦理房屋稅自用，請於3月22日前申請。\n◎辦理自用稅率需先將戶籍遷入。\n◎上列地政士代辦費，本事務所列為執行業務收入，若付款人為中華民國境內之公司行號或機關團體，請依法扣繳10%稅款 ，並開立扣繳憑單予本事務所。";
        document.getElementById('displayNotes').innerText = document.getElementById('inputNotes').value;
    }

    window.openOptionManager = function(type) {
        currentEditType = type;
        document.getElementById('modalManager').classList.remove('hidden');
        document.getElementById('modalTitle').innerText = type==='service'?'管理代辦費選項':'管理規費選項';
        renderManagerOpts();
    }
    window.closeOptionManager = function() {
        document.getElementById('modalManager').classList.add('hidden');
        refreshEditors();
    }
    function renderManagerOpts() {
        const c = document.getElementById('optionListContainer');
        const opts = currentEditType==='service'?currentServiceOpts:currentTaxOpts;
        c.innerHTML = '';
        opts.forEach((o, i) => {
            const d = document.createElement('div');
            d.className = "flex justify-between items-center bg-white border rounded px-2 py-1";
            d.innerHTML = `<span>${o}</span><button onclick="delMgrOpt(${i})" class="text-red-500"><i class="fas fa-trash"></i></button>`;
            c.appendChild(d);
        });
    }
    window.addNewOptionToManager = function() {
        const inp = document.getElementById('newOptionInput');
        if(!inp.value) return;
        (currentEditType==='service'?currentServiceOpts:currentTaxOpts).push(inp.value);
        saveOptionsLocally(); renderManagerOpts(); inp.value='';
    }
    window.delMgrOpt = function(i) {
        if(!confirm("刪除此選項？")) return;
        (currentEditType==='service'?currentServiceOpts:currentTaxOpts).splice(i,1);
        saveOptionsLocally(); renderManagerOpts();
    }

    function updateDateDisplay(val) {
        if(!val) return;
        const d = new Date(val);
        document.getElementById('displayDate').innerText = `${d.getFullYear()-1911}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
    }
    function formatCurrency(n) { return new Intl.NumberFormat('zh-TW',{style:'currency',currency:'TWD',minimumFractionDigits:0}).format(n).replace('TWD','$'); }
    
    function toggleStampMode() {
        const mode = document.querySelector('input[name="printMode"]:checked').value;
        const paper = document.getElementById('paper');
        
        if (mode === 'print') {
            paper.classList.add('hide-stamp');
        } else {
            paper.classList.remove('hide-stamp');
        }
    }

    init();
</script>
</body>
</html>